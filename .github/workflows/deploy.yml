name: Deploy Spring Boot App

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch name to deploy'
        required: true
        default: 'main'  # Default branch to deploy

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.inputs.branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Build with Maven
        run: mvn -B package --file student-crud-app-1/pom.xml

      - name: Build Docker image
        run: docker build -t spring-boot-app ./student-crud-app-1

      - name: Deploy to Docker
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/student_db?createDatabaseIfNotExists=true
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          SPRING_JPA_SHOW_SQL: true
          SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: true
          SPRING_JPA_HIBERNATE_DDL_AUTO: update
        run: |
          docker-compose up -d --build
